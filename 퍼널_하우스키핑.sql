-- 실전
WITH 
message_user as (
    select user_id
    from doeat_delivery_production.user u
    where user_phone in ('01087120786','01072100278','01090600584','01072569949','01050698798','01038972498','01056082516','01047871863','01052352954','01054254301','01088020916','01076886694','01091656591','01080777689','01085805668','01074375266','01075429182','01077633036','01092241676','01087218108','01085679142','01022366577','01029470082','01047431603','01025053922','01023791869','01095307632','01058264005','01077066603','01057496680','01035820683','01077443179','01086376102','01047225791','01051952597','01050284896','01095209967','01089187169','01099827943','01048988276','01028485677','01040681408','01083779762','01029721452','01071396421','01056866326','01045778679','01038656156','01063508915','01090771389','01051251967','01064752895','01033755792','01042075828','01072474012','01050290740','01039002975','01063198827','01024138077','01055410448','01073449753','01064193155','01041262112','01024350092','01026349723','01051504566','01094418931','01098061445','01092719883','01033777821','01051029821','01077558262','01067551516','01092563702','01084169004','01027607807','01039811321','01022674807','01045399240','01089442449','01063519743','01082320134','01097691890','01025288873','01041790319','01064897683','01025343437','01028292169','01089547884','01026291082','01024929349','01030999589','01099609863','01098845035','01090409472','01035828191','01045844107','01028692387','01042030203','01066876691','01048414378','01093761230','01041507640','01082791949','01087516233','01034798885','01086303975','01054729460','01077741997','01095583616','01088928455','01067302182','01082603438','01063084084','01081815532','01095254472','01026614998','01058985430','01050376594','01032530011','01055443829','01066286451','01075689093','01020078782','01089807422','01063471260','01067895525','01086313120','01027981936','01029578802','01083911270','01057104774','01084144224','01072248119','01055176801','01022295396','01049278102','01057021517','01034347739','01063951736','01025598472','01026526948','01062324963','01028208559','01023726040','01068360243','01067649791','01021032466','01039740587','01073708413','01037397653','01028226737','01055193394','01052967641','01051719161','01068896711','01087035642','01045063718','01075149702','01099193638','01064972780','01033740874','01063788362','01030992171','01027607163','01082801192','01034248590','01024595815','01093435076','01048098358','01076042248','01024020176','01093228461','01063420398','01086718582','01057842325','01095120956','01032642043','01098507798','01096864481','01029567906','01040160982','01023584329','01023566853','01072801158','01077251942','01064815088','01083260623','01063353755','01090490177','01085571579','01062478977','01090625436','01041566258','01064094077','01021505110','01074610121','01031119645','01039808184','01062429461','01077403291','01035650149','01086178340','01086153570','01023403555','01096506773','01072601195','01043884138','01029078784','01048147012','01041117036','01026292554','01063266867','01049089771','01051018204','01024634787','01032836954','01099509574','01096314430','01065108618','01077609020','01090326827','01099368366','01076509717','01029892788','01053567655','01033319776','01020860185','01029923389','01097806182','01033146047','01058983755','01094169926','01050420530','01076598948','01093353597','01073745988','01047070508','01020719639','01029402349','01063887071','01074246327','01041215038','01066026970','01085825611','01052743784','01027701262','01050225401','01037168776','01097999153','01046514627','01055273145','01094090735','01053232507','01027524461','01045835224','01027299073','01097116763','01033917650','01097274459','01035433691','01022106087','01034220247','01082340338','01054115067','01028725553','01056404309','01036044960','01077568431','01041529631','01092061367','01040534074','01035999438','01092180565','01074306157','01024641169','01082832254','01023082807','01056673854','01093493430','01037169637','01050189097','01099173132','01071671019','01054222954','01064493991','01084463881','01073538256','01093921754','01082606311','01084749343','01044885472','01038782151','01097581196','01071693605','01022819677','01050217464','01031611375','01063489813','01085457634','01055027095','01041804623','01088111597','01055115828','01092880947','01091410407','01027464301','01035638842','01039319307','01043662926','01093464886','01028400678','01089585967','01065506787','01079190475','01040106112','01051082596','01066288461','01024882368','01092728519','01037131745','01091109401','01089721404','01027230523','01025759552','01066273222','01094311065','01027431304','01032249428','01089115475','01086633933','01030241919','01031686865','01047993197','01045208403','01025027196','01033801875','01099495166','01046174077','01088803341','01063096896','01053956146','01089227701','01085142771','01020065217','01074213537','01032836646','01040556532','01092237617','01032535635','01039269553','01047046598','01029843362','01090570743','01038661037','01041010639','01055898653','01051248298','01094281777','01086888304','01075196177','01053301931','01065093229','01047494237','01075087514','01030381531','01048718177','01092814734','01080052778','01027295416','01055760349','01044547011','01033512905','01077455369','01048130190','01034887277','01028966717','01093907908','01028952850','01052167268','01029813012','01057520444','01027273860','01027519799','01027204737','01048576387','01025573980','01091591349','01050204868','01051038332','01044963219','01041057061','01099441086','01071509589','01033892814','01027332701','01048718453','01053195942','01052993452','01022068429','01026726642','01071204688','01049665696','01026194925','01066830385','01052566063','01022380353','01085063347','01046009412','01085378647','01087412012','01098662448','01030353273','01095730528','01099652095','01099011626','01077774325','01092953263','01054250479','01041955455','01063885507','01034555657','01025862426','01034570406','01091967202','01022218093','01095346120','01064259587','01037025509','01098062850','01091996428','01062723299','01093401835','01023109681','01090009496','01066544336','01066286439','01050613419','01043391014','01041790459','01086399851','01025565095','01050257803','01063642893','01047014987','01090851320','01062231392','01074550565','01064719805','01087941085','01046322330','01049929738','01071544887','01095015635','01049488414','01076547763','01032352091','01048478239','01041405078','01041937718','01083557435','01096633270','01059393538','01040056490','01033610410','01053575493','01055832139','01020678623','01025803696','01045632748','01033586649','01040865034','01093503046','01030304677','01050640953','01032244886','01021854753','01052496392','01025945096','01021041306','01048809186','01048090693','01092578119','01030436968','01045348542','01086026517','01099233257','01083242899','01075737429','01064101084','01048209080','01038765127','01091400503','01065992518','01040049823','01075839456','01093136256','01030221161','01093293382','01041110865','01047224988','01096002684','01027303535','01048453268','01048537791','01040125204','01026642774','01075074408','01046517665','01066988679','01074790766','01087942246','01094410767','01065489542','01099775237','01024455982','01029884527','01023731768','01027026704','01091025848','01092634055','01033922089','01022606195','01027123517','01022121698','01042078645','01073745355','01056615603','01099844637','01071866763','01077588357','01066697086','01097974651','01092369578','01057670476','01096594224','01076101811','01032843745','01044463608','01046563307','01023885705','01075505804','01091398812','01094213594','01093466569','01073786614','01064108664','01049373388','01053713134','01044611401','01025206799','01041242764','01094600575','01029912336','01084244647','01087647397','01034220907','01023989402','01055559352','01067437720','01032397149','01039086757','01051544168','01039015821','01033615416','01057933242','01085958274','01033135833','01048126971','01089401276','01079633219','01050036230','01031701965','01095602426','01033083560','01064708405','01038106682','01096731013','01044360531','01049038580','01094672506','01055821593','01025584982','01038476659','01096208140','01067882393','01046951608','01020621331','01057748675','01077011304','01085180302','01073376221','01034351038','01048090150','01072911266','01087792537','01053196959','01074942873','01076666389','01052379057','01092448102','01093885980','01039300472','01026525401','01029393365','01073400423','01020017708','01033136475','01077501176','01079397655','01077126875','01048615951','01021620625','01022670306','01067883478','01066284561','01033575061','01057653258','01033544121','01026763395','01064352939','01074715839','01077078520','01067735150','01025282682','01083877758','01072294538','01099820138','01094493142','01040046788','01089707150','01077045367','01056171004','01047446130','01087875121','01047551773','01028078288','01037531463','01041051099','01067391345','01092830848','01029279496','01028990901','01085211945','01077524936','01083961149','01073467597','01058097455','01087116130','01049936954','01072280465','01086337805','01032369219','01036837127','01055101626','01088211831','01046474632','01045952721','01051966353','01020283578','01071253332','01041235581','01020220464','01053008931','01044690604','01099448470','01058779301','01046593554','01046052908','01040282444','01093332776','01049014772','01025059620','01026096480','01030641226','01026114229','01042996074','01094624688','01022327834','01028638582','01058196616','01034179027','01066945570','01048133207','01039150495','01050966340','01030928058','01075334985','01076655693','01071876086','01044119793','01041207408','01049014974','01087737799','01093056194','01074693501','01024978370','01074422886','01023000156','01095410477','01026950389','01099203820','01037327658','01091777028','01024398334','01079992012','01049661367','01027617573','01075954320','01079348974','01077269943','01085634561','01028519964','01046562305','01099721742','01087192333','01053692275','01028599948','01048578517','01062242135','01052336927','01094108971','01093175446','01052076429','01032042289','01026922973','01050632383','01093642649','01022744454','01041900338','01020260994','01099360574','01048619493','01094163374','01040174324','01062382142','01030292117','01098663676','01053911673','01063222460','01024121812','01062888776','01075318577','01027759679','01045225349','01024721674','01095939014','01092728667','01089298186','01050250518','01033907236','01051177572','01026384138','01071809266','01066794366','01037443917','01043315456','01033802843','01036349391','01068986915','01059660152','01041826648','01095610628','01027318270','01042421371','01089270206','01042078525','01071993170','01077113027','01051194968','01028249806','01065931535','01052247320','01073293022','01034448106','01050768828','01090242811','01091564861','01028233765','01058255235','01095678243','01088678826','01030346276','01046375413','01057572615','01037746235','01055865658','01034645747','01041277935','01094785776','01099403832','01040630407','01054786193','01090415765','01049182230','01046510924','01044938979','01036540933','01071799173','01094208268','01063289158','01063546611','01037103428','01063626333','01099048681','01026074809','01056519256','01067342154','01051053129','01050014104','01035710507','01058282653','01048519254','01049210857','01023086331','01058118240','01087617472','01087210449','01094430014','01035990176','01042042850','01099166725','01039228185','01073356320','01035619368','01028936790','01046181642','01097028935','01021316322','01049488126','01089959140','01046480504','01030873197','01051777159','01083619711','01066872358','01076110592','01045453156','01088310123','01040563423','01071619441','01096919788','01055204761','01094977069','01046889298','01045833851','01047203871','01076169280','01066563938','01077948767','01054757616','01075080450','01086525792','01066271038','01023785523','01025445910','01040130348','01082437466','01064649388','01083316353','01047593554','01055108024','01030036293','01051039505','01057695296','01036399416','01089162673','01099133792','01022186496','01084243340','01096955852','01095135068','01040242670','01040560621','01099915810','01029334709','01031804876','01027519971','01027052603','01089781388','01041885608','01062327908','01077663657','01039582156','01053602750','01037270679','01052431290','01090434359','01071912423','01076275683','01055576566','01053013010','01028614766','01093700774','01089230643','01034467630','01059130824','01082228754','01077447274','01044819260','01038281569','01094494189','01027678973','01054975118','01075658512','01055113772','01026643194','01038350617','01029798108','01094386829','01056509608','01020600775','01085571506','01064385364','01042372082','01024023119','01089393572','01039772322','01066927010','01031563310','01036867587','01034337204','01086989444','01090152429','01027568644','01096004476','01096060210','01044963749','01049459996','01032587177','01053866436','01066340525','01030206881','01043353807','01085395068','01040219160','01032132794','01090374205','01049060553','01022276269','01076687852','01086114394','01076659451','01056120147','01026532601','01040668913','01090317174','01076558674','01089260830','01026485871','01033914476','01051259618','01027867726','01050627842','01094622454','01049989450','01045904450','01050085444','01071735738','01028302136','01020742051','01044890801','01037750238','01056200983','01094777512','01073208726','01020294451','01049363932','01074679179','01099202095','01075352457','01076223344','01044537730','01062555595','01076709172','01077429830','01043620217','01031546830','01073201827','01075633660','01089418004','01082266105','01032004887','01049214730','01071714010','01027970735','01088104657','01020079101','01066486988','01041984480','01034531546','01025000014','01029992082','01091549869','01041996228','01054297578','01089771701','01074242331','01051061028','01023587138','01052977980','01066389324','01033821476','01046968823','01064277409','01059143156','01044524642','01053441713','01048747499','01051090412','01062075430','01057931197','01082137171','01039404750','01041973805','01022059220','01065797891','01095550831','01048360665','01074557403','01040052695','01039507125','01075857591','01092908901','01099620138','01024601866','01058132003','01028003641','01039544991','01036602038','01050197653','01044861170','01091041821','01077601977','01035215230','01067237720','01099567654','01022008380','01077200857','01027750658','01040022091','01073655677','01028119209','01033884919','01026104772','01089728716','01042500328','01026445399','01054319616','01074091525','01041350109','01083610137','01052293097','01071590775','01022584056','01054662471','01062854314','01086660506','01072091878','01096025603','01051131567','01066089115','01074447314','01075422898','01040370431','01038836290','01098229699','01088899815','01085772626','01050028674','01065232775','01041283323','01058394421','01038976974','01050626409','01075137234','01049091875','01090120509','01030658895','01029650829','01055026014','01071493074','01056520839','01040429602','01027380438','01026465641','01055304361','01086686092','01029982488','01099102909','01067256588','01072801015','01029817632','01091371036','01050049591','01024674843','01066586910','01047624290','01037428908','01084451247','01083601646','01099508012','01031208861','01047344659','01022682808','01043991399','01073465285','01086305283','01044729461','01097070590','01051188172','01055202345','01097766695','01058754190','01056633681','01062935236','01083587728','01055016757','01082216404','01085778240','01047498287','01095361996','01030457267','01092548552','01083460092','01047385548','01063769591','01041154171','01051647482','01093798579','01096847010','01044450888','01036707752','01042193652','01062118196','01040882823','01094101332','01050056223','01087379873','01051088295','01056012685','01031181994','01047951907','01051523826','01085496347','01071728809','01039203166','01033207646','01093693925','01062570512','01098937310','01042436796','01099839310','01027163874','01030697606','01034515637','01040400463','01087939149','01071467410','01050398274','01067682482','01038649927','01048503200','01050224434','01084522292','01049294249','01076840315','01025998739','01039991549','01063555488','01020199962','01093953687','01093155037','01074181311','01042882871','01062201712','01062752459','01040387092','01089585674','01083724879','01056915043','01079054510','01099491291','01068676793','01039308521','01042404122','01039689718','01084581606','01026288579','01040683537','01053773288','01027523832','01079259903','01040398546','01022983260','01066091235','01040809284','01050556063','01050590179','01087317269','01089805590','01024330547','01089690409','01073385881','01093953877','01093100773','01094175917','01082224979','01062488932','01044289884','01026636225','01041967090','01034546380','01085428581','01043314755','01056028079','01035748612','01067780768','01062431555','01094096795','01023490083','01026728438','01087910961','01076033010','01025321693','01076803024','01047633623','01062779120','01049449472','01035437335','01050255853','01083778680','01022110733','01027580210','01068658208','01094638802','01042821527','01050364568','01026123924','01045593616','01047679134','01095661134','01067817223','01071313122','01074149338','01086384648','01098156027','01083433430','01030910031','01051319578','01030280094','01031093912','01040561746','01058828204','01077326515','01023198046','01064874492','01039016864','01087038752','01020946853','01024226407','01086700512','01031400276','01094754791','01051970219','01094259038','01073087306','01099822309','01023266337','01099390713','01050145470','01089452249','01082849508','01024806016','01048540052','01066040514','01050956369','01025776879','01082879370','01039205539','01042317575','01068004131','01025395107','01068115004','01055885844','01047167530','01072687166','01074968249','01043756308','01043901802','01055896205','01050406004','01062455797','01053770318','01045267119','01040824467','01045539590','01087023162','01045125939','01024909044','01065531301','01063307858','01093823426','01036464768','01090856676','01071960367','01049229381','01034491682','01062664941','01041271285','01020492426','01052669788','01076733366','01081128865','01074172388','01053316366','01034460813','01081162762','01092308336','01035210316','01092831413','01042665066','01099496075','01087197949','01074220785','01025216802','01022032362','01026676368','01066196675','01063859629','01022404240','01029701539','01087375493','01084774154','01057910121','01099921933','01022677585','01036669691','01099698358','01062412366','01055316327','01095998139','01091124304','01040591503','01083530895','01051513336','01091518298','01045914138','01099855752','01051658415','01093031515','01088346709','01064082514','01051777560','01030408528','01072547207','01022467305','01062158525','01029010910','01049974704','01047204127','01024861616','01058142959','01099279573','01042205119','01059555937','01033600521','01094271788','01038284702','01027683487','01086364123','01095081231','01031902956','01041542791','01040217950','01087262283','01058730315','01074286368','01090125652','01041035768','01083000957','01086008495','01066311146','01024146023','01098772191','01077025372','01020152935','01071840826','01034921250','01041543578','01055745219','01071049563','01053583290','01025874269','01098876918','01086257704','01097027750','01024066395','01066728725','01064451730','01071258985','01058091247','01053267086','01065483550','01090269426','01041973457','01056169411','01092811529','01082530307','01062381476','01086189552','01094563701','01047990123','01096583824','01055303572','01024052672','01055497680','01029700008','01072422600','01048622637','01024032098','01064279698','01031185153','01090945932','01050489293','01093273231','01074711892','01022163529','01066008274','01099183087','01099580315','01033719615','01053873075','01073555530','01082153398','01048783097','01059224324','01021363915','01086180164','01047251994','01023763586','01029097649','01056739247','01068657664','01073903104','01040633416','01079279005','01064512897','01020107439','01080198428','01058925234','01050625158','01088385526','01093260598','01055862497','01075930792','01094526206','01023446594','01063659468','01025756130','01041761018','01075431977','01056545076','01076124852','01027503047','01028334751','01026918076','01035236517','01050539546','01087759992','01049434282','01048179212','01066555744','01049184919','01040936144','01064625936','01022490508','01025346193','01041754849','01040800556','01095608565','01052453385','01086948674','01047128374','01042821031','01048703403','01057595966','01023590016','01071939528','01036626284','01027537795','01093786284','01086114032','01026667309','01039550154','01024893216','01068164993','01032453231','01064336250','01059558237','01096872232','01096924562','01074302146','01048206752','01084260832','01082200751','01032390184','01091368769','01064170639','01042414420','01065511384','01064608980','01099309467','01071895036','01032112816','01056141328','01088479178','01023629221','01068283822','01029429925','01037720764','01087315761','01080038830','01058505378','01030343481','01023091345','01090679488','01043323520','01077382910','01049071131','01082856941','01027373940','01085860613','01088312548','01020080111','01085878219','01028651401','01039457499','01066864513','01041022072','01076011982','01027992796','01094110163','01028256835','01028185068','01099144093','01022389176','01023879829','01063950914','01062329163','01037954029','01082607499','01081818056','01093261632','01073206861','01086886237','01046994736','01025537356','01027762920','01058061104','01063393916','01053270405','01053989864','01041233033','01042177916','01096621180','01072478351','01077058199','01050289075','01039080401','01082556318','01089939965','01021570215','01041809568','01042976708','01075296573','01049254901','01071887572','01080002568','01025011078','01036912749','01098034848','01085792709','01026167066','01052580120','01027564438','01032812589','01080609841','01063081666','01028876398','01068941625','01071258728','01085396443','01081394019','01035199402','01077586188','01025962069','01055064453','01076463673','01051352116','01053254796','01029969322','01047345484','01041266719','01026200844','01077914597','01022349931','01044408757','01024657205','01086820220','01051121822','01051858812','01035306601','01097735661','01038499657','01022521759','01090830723','01090178879','01075297812','01066196066','01086403236','01039236552','01050479857','01025480096','01041344680','01041127773','01072734626','01039199910','01033144169','01033982591','01084926686','01041194439','01053924154','01031604364','01039372532','01041828775','01076734173','01056808389','01092019501','01091151420','01031820209','01050069295','01048063373','01071847927','01035124693','01099409939','01082959394','01072163548','01025365895','01035823901','01056699450','01036388764','01091021622','01036119270','01039569496','01039520421','01050793937','01088274126','01048032334','01032520525','01086433508','01044405867','01029899547','01071395264','01093437440','01041182249','01024783883','01093968248','01027145871','01025575162','01040849281','01057269628','01088748055','01063847834','01059590932','01086024806','01096390360','01042291747','01063307721','01092166661','01035274809','01036987324','01087385473','01092451541','01074600056','01023201102','01081203701','01054790910','01050340229','01051018387','01085854800','01052657526','01041331193','01030510728','01099753750','01050027372','01092351850','01091867266','01022124097','01065666998','01087907234','01072051718','01056635839','01033371271','01042175873','01030883107','01025216113','01071216187','01024252670','01097172384','01072355767','01076895963','01030752475','01062330749','01057153305','01028473724','01054742107','01031096323','01051503519','01056304577','01055120480','01036986012','01028013263','01067250845','01029324834','01027234713','01022294356','01073300430','01057788824','01063654798','01096553308','01067636651','01057588327','01064605724','01024291157','01077526505','01092218804','01051202272','01067342524','01065153427','01073995459','01094706281','01033641672','01032641006','01042339275','01025898941','01042440153','01020429589','01095090336','01040538723','01031119582','01094350390','01029334015','01063212711','01080984758','01048799121','01097279610','01068229060','01027052434','01099654351','01092913725','01021677178','01046201462','01094447303','01072811863','01039228911','01040145706','01057642862','01034113406','01033364860','01092063858','01072941217','01047725306','01064148956','01090356278','01072974012','01047626841','01066465297','01066110027','01066927575','01049448198','01029731694','01049175113','01057596864','01093881583','01049063514','01046503015','01040594557','01072952701','01021602388','01021336267','01055324559','01088835765','01030601615','01038184297','01091218135','01047513911','01055247112','01042821405','01024290209','01089939835','01064262824','01052250579','01099632758','01041186458','01042929695','01047024526','01093114206','01052648419','01090770452','01040200588','01071630749','01047685276','01063091345','01034977075','01047412915','01084357933','01057972724','01086298909','01097251116','01036134367','01043998361','01085065138','01025793074','01020173743','01050633534','01024126936','01043183977','01045951201','01057723680','01089767696','01047374307','01053699802','01097960577','01030271798','01051232198','01063036391','01072808855','01093425565','01028098567','01090959490','01055946287','01029132931','01022429357','01055746222','01031473397','01062374029','01022274077','01024429051','01062333430','01072883601','01077571430','01093448832','01056585449','01045885125','01050692721','01040853222','01068886302','01044234926','01082041923','01030028953','01021053798','01084460092','01039439310','01041209579','01081697308','01093412231','01040602000','01047721312','01042351263','01034246831','01038908180','01034230311','01058833211','01038037028','01068501806','01076503969','01072782207','01091497336','01071091938','01044850336','01086359313','01091947772','01077729895','01091315118','01071647290','01094144261','01072458352','01023534048','01088386870','01064260168','01030925255','01085700351','01067381478','01075616283','01091118509','01029776784','01091393710','01044343127','01039806529','01030292375','01029544380','01072201932','01024299876','01030429702','01033890826','01035194765','01056752281','01047164566','01038441405','01074266988','01026630856','01029079788','01023114067','01072404801','01038639245','01048750966','01038768275','01082184414','01041867623','01022246321','01094207999','01066670585','01052947211','01041829670','01076121577','01095883420','01056488203','01086465182','01055003346','01068073313','01071394318','01045138059','01096130012','01091326706','01071366364','01049947128','01094186577','01026564209','01057432229','01073480801','01028209633','01054820411','01034349964','01077374193','01027015966','01029476851','01098110525','01057728662','01022089923','01027955014','01032333461','01062083094','01074263195','01027709756','01026556492','01039058203','01091240943','01029163638','01073221254','01027734667','01021944714','01089151620','01028798460','01071487866','01038588835','01030281497','01051062607','01072859630','01066474513','01062638338','01079333327','01099112004','01073909078','01049539903','01045619348','01047044372','01033857160','01081085590','01031243014','01049161379','01089858697','01049173931','01050209228','01039698843','01099377727','01041951352','01041754539','01092462709','01087073506','01094605579','01095913827','01085929287','01051061612','01064284348','01093874206','01024499615','01090214557','01089808026','01089381017','01079077085','01035453231','01095223599','01063985016','01075638053','01090586029','01087254340','01087869142','01029020508','01023499240','01057904665','01074701248','01054947069','01092430656','01087347581','01096202334','01022182587','01093818757','01043739425','01055620904','01073500577','01048746746','01052236407','01090572402','01086357428','01071304208','01047315629','01066358524','01077056432','01092805977','01094935073','01091919888','01022800275','01032119310','01034324797','01033880249','01027808979','01027302708','01043580582','01084898144','01020611374','01064124406','01055348406','01025386245','01043767704','01049361452','01047381118','01064965712','01095942866','01035206127','01058335380','01087022139','01034384752','01079123986','01030003754','01068510827','01062496562','01047610923','01059105303','01063129606','01037658364','01038828169','01051889550','01026249808','01066237099','01095913136','01052314983','01037283962','01092735608','01063914531','01053322997','01023785792','01062751208','01022894429','01057955477','01091826545','01094411718','01062588206','01067416322','01095994945','01077780309','01094190488','01027263447','01066517140','01066933721','01028601362','01083021238','01024275899','01092080710','01049232004','01098623623','01062252941','01023352339','01091083680','01098683338','01050172697','01035425375','01080503800','01084032139','01035348847','01022855286','01030481045','01066792936','01034136248','01029978639','01025510704','01076334703','01066178468','01098601658','01020345856','01021362834','01024991627','01099741209','01025839054','01051485780','01042224589','01041243968','01023889030','01094083619','01024763558','01028117529','01035014030','01092382667','01058573804','01079276027','01071826275','01072551731','01062817745','01071794681','01034805574','01055217533','01090436626','01076899578','01071595134','01064961303','01025502982','01027979104','01034745207','01027576314','01071744850','01066663575','01039907294','01051649327','01039377336','01037298976','01076557565','01045957923','01077403378','01045827509','01038253847','01031023542','01027933017','01051075820','01056436113','01083786024','01077724642','01094635986','01094664270','01095594349','01028732177','01063546894','01033449232','01049433561','01040247858','01048804263','01047073606','01030471995','01068306543','01062710717','01085152637','01024366243','01091295339','01044012809','01055143263','01080017993','01027744948','01039756553','01099359593','01088436782','01046709861','01056239399','01072419030','01062543501','01023623044','01099448646','01023662306','01062593676','01058467947','01030200568','01023162403','01087847735','01097529893','01042071537','01040436929','01076864251','01032617970','01033468590','01085297462','01052434373','01074554369','01055442465','01099809703','01030937481','01020901804','01090452059','01036665954','01082796162','01064775423','01052959668','01027128527','01073226997','01099626424','01073568983','01032011728','01080729579','01073638129','01052796390','01039499411','01066262240','01080346776','01045985654','01033467207','01099490223','01031807144','01040165626','01067682414','01053958343','01051959323','01066514766','01039939638','01020546291','01050062019','01052364056','01087048487','01041619380','01050984703','01080312560','01036063519','01026996718','01040758653','01095290822','01036935624','01034803194','01022506235','01091316647','01090550360','01056583497','01050291800','01026385858','01025819198','01075338267','01047061487','01030944117','01036472803','01097920779','01068803458','01087049353','01033824097','01022615618','01043384358','01045052019','01072882937','01068600120','01036113498','01098708845','01084832354','01080119764','01081931318','01092682973','01037823205','01023197535','01053401783','01077532825','01033221278','01097003718','01071040776','01094065836','01040767477','01058384771','01038729529','01033880339','01074940527','01086028810','01082089753','01029339125','01049991091','01041797302','01080047267','01047880628','01041253567','01098536769','01062722157','01039408825','01087383630','01024879296','01057675972','01079120629','01032830076','01026630825','01071420554','01026375284','01051220029','01044995405','01026999854','01024087489','01092274646','01029590836','01044524437','01050133152','01065036312','01033636258','01041955999','01072060987','01028742697','01023290386','01092133267','01087853848','01066579140','01056981096','01098995183','01020371181','01065231498','01020711000','01052290212','01062633044','01023667322','01039367836','01059255433','01091933744','01099194715','01023767858','01063629042','01091426944','01020245745','01023727991','01033223159','01056032950','01091969348','01096070327','01099911898','01029594243','01041190861','01055410251','01058427947','01098487321','01043359025','01025804819','01048792526','01090055052','01083713897','01071354669','01088967060','01086077451','01044300262','01057161955','01092231463','01041837850','01080202913','01086695488','01051992364','01048094770','01093084886','01031619943','01030212130','01088600107','01090313829','01035557899','01083519221','01030121907','01038930568','01030232687','01067412030','01024524517','01089061412','01041687275','01074178017','01098741222','01096867203','01041180626','01071889704','01090931786','01030264682','01055947222','01064130028','01051715551','01054947640','01023115418','01098580936','01057126322','01034770993','01025987589','01051195618','01052555745','01033372365','01094145177','01097024014','01086550813','01033150865','01053920947','01042063457','01088950754','01028832722','01082911017','01086036141','01094178098','01099038467','01045878486','01043989804','01049102772','01047989783','01080288943','01064815684','01096586562','01058118979','01057466551','01038033101','01088728677','01036796560','01053581156','01097706906','01093309268','01075328942','01077883029','01056470597','01092490016','01092577697','01063234363','01041931331','01055600705','01096810205','01062153138','01026777453','01068664205','01047791659','01029855880','01071424549','01059625358','01044582231','01024633457','01035484021','01093218536','01090398605','01033614617','01090521168','01073102420','01085160243','01067712900','01093823758','01050931194','01044307253','01086014782','01075151967','01062012086','01092649721','01084753747','01093082220','01093498756','01026758363','01086937708','01034926852','01076273687','01056065706','01049981830','01080213570','01065888394','01046004702','01079199890','01066350531','01096916163','01032211183','01052631529','01082313183','01098186509','01066590576','01063379529','01088222173','01090799175','01034539510','01046605090','01075790898','01046921386','01043225575','01094607582','01033170210','01062481573','01022524524','01026411514','01073878857','01026416795','01024314666','01032472299','01089653074','01034556052','01024776552','01023316592','01065490616','01050841030','01094226854','01085556170','01092396377','01033969825','01051869094','01035320772','01038907509','01096125118','01026977020','01094263655','01099258552','01087501280','01095519568','01071182655','01050582789','01033062107','01023724423','01022963919','01025957906','01087690216','01096137923','01024029741','01022585691','01092972401','01031032569','01055306088','01030139255','01030817240','01098919118','01043474313','01023514587','01091835748','01055589472','01097608512','01092739372','01025921856','01056576013','01044041862','01046545077','01073931921','01087072777','01024606592','01043336639','01042304631','01050941748','01089779395','01058455400','01072242421','01032853883','01096797833','01049015814','01035541417','01040333779','01027703769','01051650604','01022700222','01034136873','01058423652','01051406481','01099502105','01025488026','01026379690','01098196474','01063605528','01095969125','01053532531','01048308696','01040335792','01051541099','01031307927','01062555821','01047392339','01076104342','01083376115','01066755338','01034561584','01092294762','01034971719','01092707756','01099135387','01084870285','01086819084','01026539638','01072204484','01042081105','01029202439','01057257698','01020071271','01044632717','01029597913','01032692934','01054744046','01099381913','01086893601','01075892607','01033235461','01056789009','01029731521','01089077695','01033821621','01096257883','01057733014','01086307129','01092516345','01090807054','01048795319','01023842810','01033073160','01063771316','01099025572','01082618456','01083343809','01075282383','01077341772','01038909059','01025931148','01029390849','01029489108','01023733101','01094505370','01090280366','01044544334','01051739963','01089719532','01027536026','01038364017','01021264525','01091386648','01045703298','01048206765','01045597639','01083756679','01085303265','01040260393','01083783425','01065220917','01051660234','01035051595','01045074125','01082209777','01085115013','01055901061','01083232983','01038526457','01076635996','01055576827','01083180557','01058428904','01051061453','01030464047','01077042423','01047831064','01028412227','01091971033','01062791920','01024857424','01023384462','01037793464','01067828031','01088335087','01024901353','01079342489','01091087102','01071703892','01074172112','01030869573','01086696325','01051976958','01064846928','01072700944','01048276770','01067411441','01039594219','01056581390','01090842599','01021117515','01051855989','01092922432','01034116514','01046760083','01095561495','01026788921','01062569129','01039356339','01074467903','01055437082','01082953722','01030636165','01052987922','01026476904','01072097808','01091970524','01027279636','01096967396','01058526651','01056367459','01085834693','01047141281','01025848331','01092854457','01091546735','01093823475','01056207333','01073948001','01075525541','01059338672','01085375365','01090087947','01030409805','01051016199','01031129807','01038260385','01039773732','01050319736','01091146169','01075254774','01065073258','01023770034','01062390385','01044351992','01068070520','01031440777','01082986323','01077628686','01020825699','01025406658','01027983805','01065409533','01023323620','01044253161','01055490443','01097418041','01051036428','01092553066','01053981623','01023095036','01046904164','01082331085','01059622021','01081190565','01031863592','01049267575','01049655747','01056981297','01049498872','01033910340','01064123317','01058995720','01066341242','01055879667','01027680816','01071616149','01073584242','01077481994','01071799921','01023660209','01067766183','01074086318','01031939027','01074449841','01091687291','01041293261','01094339081','01071592268','01099851969','01039327805','01032821165','01077417559','01050385029','01044232700','01032599302','01082008910','01080109925','01039440875','01030435842','01026266347','01048158767','01090352796','01025567441','01034644946','01039165043','01040371978','01028119848','01056224315','01076889572','01028265153','01075527102','01045282096','01050139457','01038411850','01089747572','01053796279','01071443650','01095199787','01092567253','01076653974','01073193027','01073865010','01048553377','01055374049','01075773279','01079793296','01030844404','01086480067','01096061399','01096326239','01084176255','01042918599','01034007862','01073181677','01054510631','01051829996','01098814689','01062667627','01044343446','01032500170','01046745835','01026349232','01072585099','01066498868','01053957913','01066499300','01047433298','01024359775','01099403554','01098874234','01098192128','01039538371','01030602724','01064891803','01089140634','01053389743','01023905457','01086050225','01068840213','01049140808','01024301897','01049634523','01039939853','01041951104','01042774422','01080135162','01026606900','01066241028','01043273362','01073538172'))

, log_data AS (
    SELECT DISTINCT 
        mt.operation_date,
        l.user_id,
        1 AS has_main,
        MAX(CASE WHEN log_type = 'house-keeping' and log_route = 'house-keeping-main' THEN 1 ELSE 0 END) AS has_page_enter,
        MAX(CASE WHEN log_type = 'house-keeping' and log_action = 'click-청소맡기기' THEN 1 ELSE 0 END) AS has_menucard_click,
        MAX(CASE WHEN log_type = 'house-keeping' and log_route = 'house-keeping-order-detail' THEN 1 ELSE 0 END) AS has_order_page_enter,
        MAX(CASE WHEN log_type = 'house-keeping' and log_action = 'click-bottom-button' and log_route = 'house-keeping-order-detail' THEN 1 ELSE 0 END) AS has_order_click,
        MAX(CASE WHEN log_type = 'house-keeping' and log_route = 'house-keeping-payment-confirm' THEN 1 ELSE 0 END) AS has_pay_page_enter,
        MAX(CASE WHEN log_type = 'house-keeping' and log_action = 'click-payment-confirm-button' and log_route = 'house-keeping-payment-confirm' THEN 1 ELSE 0 END) AS has_pay_click,
        MAX(CASE WHEN log_type = 'house-keeping' and log_action = '토스페이 등록 시도' and log_route = 'house-keeping-payment-confirm' THEN 1 ELSE 0 END) AS has_pay_toss,
        MAX(CASE WHEN log_type = 'house-keeping' and log_action = '예약 완료' THEN 1 ELSE 0 END) AS has_pay_complete        
    FROM (select * from service_log.user_log l
            where (l.dt >= '{{시작시각}}'::date and l.dt<='{{종료시각}}'::date)
            and l.created_at between '{{시작시각}}' and '{{종료시각}}') l
    LEFT JOIN doeat_data_mart.mart_date_timeslot_general mt 
            ON l.dt = mt.date 
                AND EXTRACT(hour FROM l.created_at::timestamp) = mt.hour
    join doeat_delivery_production.user u on u.user_id = l.user_id
    WHERE 1
    and u.authority = 'GENERAL'
    GROUP BY 1, 2
),

order_data AS (
    SELECT DISTINCT 
        mt.operation_date,
        o.user_id,
        1 as has_order
    FROM doeat_delivery_production.orders o
    JOIN doeat_delivery_production.team_order tm ON o.team_order_id = tm.id
    join doeat_delivery_production.item i on o.id = i.order_id
    LEFT JOIN doeat_data_mart.mart_date_timeslot_general mt 
        ON DATE(o.created_at) = mt.date 
        AND EXTRACT(hour FROM o.created_at) = mt.hour
    WHERE o.orderyn = 1
        AND o.paid_at IS NOT NULL
        AND o.status IN ('ORDERED', 'COOKING', 'DELIVERING', 'DELIVERED')
        AND tm.is_test_team_order = 0
        and o.created_at::timestamp between '{{시작시각}}' and '{{종료시각}}'
),

membership AS (
    SELECT DISTINCT 
        mt.operation_date, 
        m.user_id,
        1 as has_membership        
    FROM doeat_delivery_production.membership_subscription m
    LEFT JOIN doeat_data_mart.mart_date_timeslot_general mt 
        ON DATE(m.subscription_start_at) = mt.date 
        AND EXTRACT(hour FROM m.subscription_start_at) = mt.hour
    WHERE m.is_free_trial = 1
    and operation_date::timestamp between '{{시작시각}}'::date and '{{종료시각}}'::date

)

, cached_query as (SELECT 
                    count(case when mu.user_id is not null then 1 end) as 문자발송,
                    COUNT(CASE WHEN l.has_main = 1 THEN 1 END) AS 앱진입,
                    COUNT(CASE WHEN l.has_main = 1 AND l.has_page_enter = 1 THEN 1 END) AS 이벤트페이지진입,
                    COUNT(CASE WHEN l.has_main = 1 AND l.has_page_enter = 1 AND l.has_menucard_click = 1 THEN 1 END) AS 청소맡기기클릭,
                    COUNT(CASE WHEN l.has_main = 1 AND l.has_page_enter = 1 AND l.has_menucard_click = 1 and l.has_order_page_enter = 1 THEN 1 END) AS 주문설정페이지진입,
                    COUNT(CASE WHEN l.has_main = 1 AND l.has_page_enter = 1 AND l.has_menucard_click = 1 and l.has_order_page_enter = 1 and l.has_order_click = 1 THEN 1 END) AS 주문하기클릭,
                    COUNT(CASE WHEN l.has_main = 1 AND l.has_page_enter = 1 AND l.has_menucard_click = 1 and l.has_order_page_enter = 1 and l.has_order_click = 1 and l.has_pay_page_enter = 1 THEN 1 END) AS 결제페이지진입,
                    COUNT(CASE WHEN l.has_main = 1 AND l.has_page_enter = 1 AND l.has_menucard_click = 1 and l.has_order_page_enter = 1 and l.has_order_click = 1 and l.has_pay_page_enter = 1 and l.has_pay_click = 1 THEN 1 END) AS 결제하기클릭,
                    COUNT(CASE WHEN l.has_main = 1 and l.has_pay_page_enter = 1 and l.has_pay_toss = 1 THEN 1 END) AS 토스페이등록,     
                    COUNT(CASE WHEN l.has_pay_complete = 1 THEN 1 END) AS 주문완료,   
                    COUNT(CASE WHEN o.has_order = 1 and m.has_membership = 1 THEN 1 END) AS 멤버십가입  
                
                FROM log_data l 
                LEFT JOIN order_data o ON l.operation_date = o.operation_date AND l.user_id = o.user_id
                LEFT JOIN membership m ON l.operation_date = m.operation_date AND l.user_id = m.user_id
                left join message_user mu on mu.user_id = l.user_id
                join doeat_delivery_production.user u on l.user_id = u.user_id
                join doeat_delivery_production.user_address ua on ua.user_id = l.user_id
                where ua.is_main_address = 1 
                    and (('{{행정동}}' != '전체' and ua.hname = '{{행정동}}') or ('{{행정동}}' = '전체'))
                    and ua.sigungu = '관악구'


                ORDER BY 1
)

SELECT step, sum(cnt) as cnt
FROM (
    SELECT '1. 앱진입' AS step, 앱진입 AS cnt FROM cached_query
    UNION ALL
    SELECT  '2. 랜딩페이지진입' AS step, 이벤트페이지진입 AS cnt FROM cached_query
    UNION ALL
    SELECT  '3. 청소맡기기클릭' AS step, 청소맡기기클릭 AS cnt FROM cached_query
    UNION ALL
    SELECT  '4. 주문설정페이지진입' AS step, 주문설정페이지진입 AS cnt FROM cached_query
    UNION ALL
    SELECT  '5. 주문하기클릭' AS step, 주문하기클릭 AS cnt FROM cached_query
    UNION ALL
    SELECT  '6. 결제페이지진입' AS step, 결제페이지진입 AS cnt FROM cached_query
    UNION ALL
    SELECT '7. 결제하기클릭' AS step, 결제하기클릭 AS cnt FROM cached_query
    UNION ALL
    SELECT  '8. 토스페이등록' AS step, 토스페이등록 AS cnt FROM cached_query
    UNION ALL
    SELECT '9. 주문완료' AS step, 주문완료 AS cnt FROM cached_query
    -- UNION ALL
    -- SELECT date, '9-2. 멤버십 가입' AS step, 멤버십가입 AS cnt FROM cached_query
)

GROUP BY 1
